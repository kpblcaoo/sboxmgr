# CLI scenarios & outputs (для декомпозиции и тестирования)

| Сценарий         | Флаги/аргументы           | Выход/действие                | Формат вывода      |
|------------------|--------------------------|-------------------------------|--------------------|
| exclusions-only  | --exclude, --exclude-only| Обновление exclusions.json, печать списка | stdout, файл      |
| dry-run          | --dry-run                | Консольный отчёт, валидация   | stdout             |
| run              | --index, --remarks       | Генерация и запись конфига    | файл, stdout (лог) |
| list-servers     | --list-servers           | Табличный вывод серверов      | stdout             |
| clear-exclusions | --clear-exclusions       | Сброс exclusions.json         | stdout, файл       |
| auto-selection   | (по умолчанию)           | Выбор лучшего сервера         | файл, stdout (лог) |

- Для каждой команды фиксировать формат выхода (stdout, файл, JSON и т.д.)
- Таблица будет вынесена в документацию после завершения декомпозиции

# План декомпозиции main.py и дальнейшего рефакторинга CLI (v2, data-driven)

## Цели
- Упростить main.py, сделать его точкой входа и маршрутизатором CLI-команд.
- Вынести обработчики CLI-сценариев (exclusions, dry-run, selection, генерация конфига и т.д.) в отдельные функции/модули.
- Минимизировать дублирование паттернов (выбор outbounds, excluded_ips, selected_indices).
- Повысить читаемость, тестируемость и расширяемость CLI.
- Внедрить Typer для современного и удобного CLI-интерфейса.
- **Обработчики CLI (handle_...) должны быть thin: только orchestration, без бизнес-логики. Вся логика — в core-модулях.**
- **CLI-обработчики структурировать как пакет cli/ с отдельными файлами по сценариям (exclusions.py, dry_run.py и т.д.).**
- **Вся работа по рефакторингу — только в отдельной ветке (например, refactor/cli), с поэтапными коммитами.**
- **Фиксировать lessons learned и сложности по ходу выполнения (раздел в конце файла).**

## CLI compatibility policy
- Любое переименование флагов, удаление опций, изменение структуры команд — считается breaking change и требует отдельного changelog и обсуждения.
- Обратимые изменения: добавление новых опций, алиасов, help, не влияющих на существующие сценарии.
- Все breaking changes должны быть явно задокументированы.

## Этапы (с оценкой уверенности и осведомлённости)

### 1. Анализ и разметка сценариев
- Описать все основные сценарии CLI: exclusions-only, dry-run, обычный run, list-servers, clear-exclusions, auto-selection и их комбинации.
- Для каждого сценария выделить входные параметры, точки вызова, повторяющиеся блоки.
- **Уверенность: 100%** (структура сценариев полностью видна по struct.json и коду)
- **Осведомлённость: высокая** (все зависимости и вызовы известны)

### 2. Вынести обработчики CLI-команд
- Для каждого сценария создать отдельную функцию (например, handle_exclude, handle_dry_run, handle_selection, handle_clear_exclusions).
- Вынести эти функции в отдельный модуль cli/ (exclusions.py, dry_run.py, selection.py и т.д.).
- В main.py оставить только парсинг аргументов и маршрутизацию по сценариям.
- **Уверенность: 95%** (структура сценариев и их зависимости прозрачны, возможны edge-cases с передачей параметров)
- **Осведомлённость: высокая** (по struct.json и коду)

### 3. Унификация подготовки данных
- Вынести повторяющиеся блоки подготовки outbounds, excluded_ips, selected_indices в отдельные утилиты.
- Использовать их во всех обработчиках CLI.
- **Уверенность: 90%** (паттерны повторяются, но возможны нюансы с dry-run/selection)
- **Осведомлённость: высокая** (видно по коду и struct.json)

### 3a. Управляемые пути для логов и артефактов через переменные окружения
- Все пути к логам и артефактам (exclusions.json, config.json, лог-файл) должны задаваться через переменные окружения с безопасными дефолтами (например, `LOG_PATH = os.environ.get("SBOXMGR_LOG", "./sboxmgr.log")`).
- В тестах все пути должны задаваться явно через monkeypatch/setenv или mock, чтобы исключить побочные эффекты и доступ к реальной среде.
- Артефакты: `SBOXMGR_CONFIG`, `SBOXMGR_EXCLUSIONS`, `SBOXMGR_LOG` и т.д. — аналогично.
- При переходе на Typer — можно добавить флаг `--log`, но это вторично по сравнению с переменными окружения.
- **Почему важно:**
    - Проблемы с правами на запись — частая причина фейлов CLI.
    - Тесты без управляемых путей к артефактам нестабильны и зависят от внешнего состояния.
    - Логика путей не должна быть захардкожена — она должна быть управляемой и легко подменяемой для тестов.

### 4. Внедрение Typer для CLI
- Перевести парсинг аргументов и маршрутизацию CLI на Typer.
- Обеспечить автогенерацию help, поддержку вложенных команд, алиасов, автокомплита.
- Перенести обработчики CLI-сценариев в команды Typer.
- **Тесты CLI переводить на Typer.CliRunner (typer.testing)** для эмуляции команд, проверки stdout/stderr и кодов возврата.
- **Уверенность: 85%** (Typer хорошо подходит для такой структуры, возможны нюансы с backward compatibility и тестами)
- **Осведомлённость: высокая** (структура CLI и сценариев известна, опыт внедрения Typer есть)

### 5. Улучшение тестируемости
- Обновить/добавить тесты для новых CLI-обработчиков и команд Typer.
- Проверить, что все сценарии CLI покрыты тестами (в том числе edge cases).
- **Уверенность: 95%** (тесты уже хорошо покрывают CLI, потребуется адаптация под Typer)
- **Осведомлённость: высокая** (структура тестов и сценариев известна)

### 6. Документация и changelog
- Описать новую архитектуру CLI и best practices для новых разработчиков.
- Обновить changelog и README.
- **Уверенность: 100%** (документация полностью под нашим контролем)
- **Осведомлённость: полная**

## Минимизация риска
- Делать рефакторинг поэтапно, после каждого шага — запускать тесты и вручную проверять CLI.
- Не менять бизнес-логику, только структуру и маршрутизацию.
- Сохранять обратную совместимость CLI-флагов и сценариев (по возможности).

## Lessons learned (фиксировать по ходу)
- 2024-06-19: CLI matrix полностью зелёная, tolerant-поиск реализован, баг с exclusions и возвратом сервера исправлен. Все тесты CLI проходят.
- 2024-06-19: Вся логика выбора серверов, outbounds, exclusions теперь централизована в cli_common.py. Повторяющиеся паттерны устранены.
- 2024-06-19: Начат перенос CLI на Typer. Структура src/updsbox/cli/ выбрана по best practices: единый namespace, расширяемость, удобство тестирования.
- 2024-06-19: Произведён ребрендинг: проект переименован в updsbox для уникальности и избежания пересечений с upstream sing-box.
- 2024-06-19: Финальный бренд: пакет/namespace — sboxmgr, CLI — sboxctl. Переменные окружения SBOXMGR_..., CLI help и systemd — sboxctl, SINGBOX_URL оставляем для подписок. Начато массовое переименование по этим правилам.
- 2024-06-20: Проект переведён на pyproject.toml (PEP 621):
    - requirements.txt удалён, все зависимости теперь только в pyproject.toml.
    - Разделены prod/dev зависимости (dev: pytest, black, pre-commit и др.).
    - Добавлен entry point для CLI: команда sboxctl теперь доступна после установки.
    - CLI можно запускать как sboxctl ... после pip install .
    - Все изменения фиксируются поэтапно, чтобы не терять знание и историю миграции.
- [x] Добавлена автоматическая загрузка .env через load_dotenv() в main.py, теперь переменные окружения из .env всегда подхватываются CLI (и для dev, и для пользователей).
- [x] Принято временное решение: CLI и тесты могут использовать переменные окружения из .env (SBOXMGR_URL, SINGBOX_URL, TEST_URL) для URL, чтобы обеспечить удобство и совместимость до полной изоляции тестов. Это зафиксировано как допустимый dev-паттерн.
- [x] Функция generate_config теперь использует tempfile для временного файла (безопасно, без гонок и проблем с правами). Все тесты подменяют пути к артефактам через monkeypatch/setenv (best practice для CLI и тестов).
- [x] Устранён DeprecationWarning (datetime.datetime.utcnow -> datetime.datetime.now(datetime.UTC)), теперь тесты полностью зелёные и без варнингов. Можно переходить к адаптации и запуску остальных тестов.

## Выполнено
- [x] CLI matrix-тесты: файл создан, базовая таблица и структура pytest реализованы.
- [x] Модуль utils/cli_common.py: создан, заглушки для общих функций добавлены.
- [x] Документация CLI-сценариев: таблица входов/выходов добавлена в changelog.
- [x] CLI matrix полностью изолирован от systemctl/root, tolerant-поиск сообщений реализован.
- [x] Исправлен баг с exclusions и возвратом сервера (затенение функции переменной).
- [x] Все тесты CLI проходят, включая edge-cases и возврат сервера.
- [x] Унификация подготовки данных: вся логика выбора серверов, outbounds, exclusions вынесена в cli_common.py, дублирование устранено.
- [x] Вся бизнес-логика CLI централизована в cli_common.py и связанных модулях, CLI-обёртка теперь полностью на Typer.
- [x] Проведена ревизия CLI, устранено дублирование, старый main.py можно удалить после миграции тестов.
- [x] Внедрён Typer, декомпозиция команд завершена, структура CLI готова к расширению и тестированию.
- [x] Перевести зависимости на pyproject.toml, удалить requirements.txt, настроить entry point для CLI (sboxctl), разделить prod/dev зависимости.
- [ ] Проверить и скорректировать все личные данные (authors, email и т.д.) в pyproject.toml, лицензии, README, документации, чтобы не было placeholder-ов и некорректных данных.

## Next steps
- [ ] Перенести/адаптировать тесты для Typer CLI (pytest + Typer.CliRunner).
- [ ] Обновить/добавить документацию и changelog по новой архитектуре CLI.

## 2024-06-18: Matrix CLI — финальный прогресс и оставшиеся несовпадения
- Matrix CLI полностью изолирован, не зависит от root/systemctl, выявляет только реальные несовпадения между тестовой документацией и CLI.
- CLI в боевом режиме работает корректно (ручная проверка).
- Оставшиеся ошибки matrix:
  1. Код возврата 1 при базовом запуске (возможно, manage_service не полностью замокан или subprocess внутри main.py не перехвачен).
  2. Нет ожидаемых сообщений ('dry-run', 'Excluding server') в выводе или логе (CLI пишет их только в debug-лог или stdout, либо текст отличается).
- Следующий шаг: обсудить, что фиксить в тестах, что — в документации, что — в коде (по согласованию).

(дополнять по мере выполнения) 