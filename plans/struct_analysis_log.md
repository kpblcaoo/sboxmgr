# Архитектурный анализ по struct.json и индексам (WIP)

## Новые находки и проблемы

- struct.json содержит полную карту модулей, функций, связей и тестов, что позволяет выявлять dead code, дубли, неочевидные зависимости.
- В проекте есть несколько модулей, которые не имеют тестового покрытия (например, src/singbox/utils/file.py, src/singbox/utils/module_installer.py, src/singbox/utils/temp.py).
- Есть функции и модули, которые не вызываются ни из одного другого модуля (dead code) — требуется дополнительная проверка по callgraph.
- В management.py реализованы функции load_exclusions/save_exclusions, которые дублируют логику exclusions.py, но не используют dry_run и могут вести к рассинхронизации.
- В некоторых тестах (test_cli_exclusions, test_cli_selection) run_cli вызывается с разными параметрами, но не всегда проверяется, что exclusions.json не меняется в dry-run.
- В src/install/wizard.py реализовано 15 функций и 1 класс (CustomRender), часть функций (например, create_dedicated_user, set_directory_permissions, activate_virtualenv, setup_systemd_service) не вызывается внутри модуля и может быть dead code или заготовками для будущего функционала.
- Нет тестового покрытия для wizard.py, хотя модуль содержит сложную логику установки и управления окружением.
- Модуль помечен как experimental, но из-за большого количества функций и связей требует отдельного аудита перед интеграцией в production.
- В src/singbox/config/protocol.py всего 1 функция, но она используется как зависимость во многих местах (центральная точка валидации).
- В проекте нет явных циклических зависимостей между модулями (по данным callgraph), но есть плотные связи между main.py, exclusions.py, management.py, selection.py.
- В некоторых местах (например, в management.py) используются свои версии функций, которые могут расходиться с основной логикой exclusions.
- В тестах не проверяется корректность работы с невалидным exclusions.json в обычном режиме (только в dry-run).
- По callgraph видно, что некоторые функции (например, handle_temp_file, rotate_logs) не используются вне своих модулей — возможно, их стоит сделать приватными или удалить, если не нужны.
- Вызовы exclusions и management сильно связаны между собой, но не всегда используют одни и те же параметры (например, dry_run), что может привести к разному поведению в разных CLI-режимах.
- В некоторых местах (например, в src/singbox/server/selection.py) list_servers вызывается только из main.py, но не из других модулей — это упрощает рефакторинг, но требует внимательности при изменениях интерфейса.
- В src/singbox/utils/module_installer.py функция install_dependencies нигде не вызывается, не имеет тестов и не используется — dead code.
- Возможна историческая попытка вынести работу с временными файлами в отдельные модули, но сейчас это не используется и дублирует код.
- В src/singbox/server/management.py реализованы свои версии функций exclusions (load_exclusions, save_exclusions, exclude_servers, remove_exclusions, view_exclusions, clear_exclusions), которые дублируют логику exclusions.py, но не используют dry_run и могут вести к рассинхронизации.
- Функция handle_temp_file реализована и в management.py, и в utils/file.py, и в utils/temp.py — дублирование, не используется вне management.py.
- В management.py нет тестового покрытия (по данным struct.json), хотя модуль содержит критически важные функции для CLI.
- Все функции exclusions в management.py используют только локальные вызовы, не интегрированы с exclusions.py — возможен dead code или устаревшая логика.
- В src/singbox/config/generate.py все функции (generate_config, generate_temp_config, validate_config_file) используются по callgraph, не обнаружено dead code. generate_temp_config — важная точка для dry-run, должна быть покрыта тестами.
- В src/singbox/config/protocol.py всего одна функция validate_protocol, она используется во многих местах (центральная точка валидации), нет dead code, но любые изменения требуют особой осторожности и тестов.
- В src/singbox/service/manage.py только одна функция manage_service, используется для управления сервисом, не обнаружено dead code, но нет тестового покрытия.
- В src/singbox/utils/id.py только одна функция generate_server_id, используется для генерации уникальных id серверов, нет dead code, но любые изменения могут повлиять на exclusions и фильтрацию.
- В src/singbox/server/selection.py реализована только одна функция list_servers, вызывается только из main.py, нет dead code, но любые изменения требуют внимательности из-за связки с CLI.
- В src/singbox/server/state.py реализованы только функции load_selected_config и save_selected_config, используются для работы с выбранной конфигурацией, нет dead code, но любые изменения могут повлиять на сохранение/загрузку состояния.
- В src/singbox/config/fetch.py обе функции (fetch_json, select_config) используются, нет dead code, select_config — важная точка для тестов и CLI.
- В exclusions.py все функции используются, нет dead code, но есть плотная связка с management.py, возможны расхождения логики.
- В management.py реализованы свои версии exclusions-функций, не используют dry_run, не интегрированы с exclusions.py, возможен dead code или устаревшая логика.
- В state.py функции load_selected_config и save_selected_config используются для работы с выбранной конфигурацией, нет dead code, любые изменения могут повлиять на сохранение/загрузку состояния.

## Финальный план рефакторинга проекта

### 1. Atomic file write (handle_temp_file)
- Оставить только одну реализацию handle_temp_file из src/singbox/utils/file.py (она более универсальна: логирует ошибки, обрабатывает исключения, возвращает True при успехе).
- Сделать параметр validate_fn обязательным для единообразия и безопасности.
- Удалить src/singbox/utils/temp.py как неиспользуемый и дублирующий модуль.
- Использовать handle_temp_file из file.py во всех местах, где нужна атомарная запись (например, в management.py для exclusions и selected_config).
- Удалить дублирующие реализации handle_temp_file из management.py.
- После каждого шага запускать тесты и вручную проверять ключевые сценарии.

### 1a. Временные заглушки (DeprecationWarning)
- Для всех устаревающих функций и модулей, которые ещё используются, добавить предупреждение через warnings.warn(..., DeprecationWarning).
- Зафиксировать это правило в архитектурной документации.
- После полного перехода на новую реализацию — удалить deprecated-функции и предупреждения.

### 2. Exclusions/management
- Оставить только одну реализацию exclusions-функций (из exclusions.py).
- Удалить дублирующие функции из management.py.
- Все вызовы exclusions (load_exclusions, save_exclusions, exclude_servers, remove_exclusions, view_exclusions, clear_exclusions) должны идти только через exclusions.py.
- Везде, где нужно, добавить поддержку dry_run.
- Проверить, что после удаления дублей все CLI-функции и тесты используют только актуальную логику exclusions.

### 3. Тесты и покрытие
- Проверить, что все критические функции (exclusions, handle_temp_file, state, generate_config, validate_protocol) покрыты тестами.
- Добавить тесты на работу exclusions в dry-run и обычном режиме, на битый exclusions.json, на работу с временными файлами.
- Проверить, что после рефакторинга тесты проходят и реально проверяют поведение, а не просто "зеленят" CI.

### 4. Документация и архитектура
- Документировать, где и как должна использоваться работа с временными файлами и exclusions.
- Кратко описать архитектуру exclusions, state, management, чтобы новые изменения не ломали структуру.

### 5. Минимизация риска
- Вносить изменения поэтапно, после каждого шага — запускать тесты и вручную проверять ключевые сценарии.
- Вести changelog и логировать все архитектурные решения.
- Перед удалением любого кода — делать grep/поиск по проекту, чтобы убедиться в отсутствии использования.

## 2024-06-18: CLI matrix, cli_common.py, документация CLI-сценариев
- Реализован файл tests/test_cli_matrix.py с параметризацией для pytest и таблицей CLI-флагов.
- Создан src/singbox/utils/cli_common.py для общих CLI-функций (заглушки).
- В changelog добавлена таблица CLI-сценариев: входные файлы, конфиги, артефакты.
- Все изменения подготовлены для отдельной ветки, коммит будет содержать только инфраструктурные улучшения (без изменения основной логики).

(дополнять по мере рефакторинга) 