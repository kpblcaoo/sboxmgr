# ADR-0020: CLI Command Structure - Two-Layer Architecture

## –°—Ç–∞—Ç—É—Å

**–î–∞—Ç–∞:** 2025-07-19
**–°—Ç–∞—Ç—É—Å:** ‚úÖ **–ü–†–ò–ù–Ø–¢–û**
**–ö–æ–Ω—Ç–µ–∫—Å—Ç:** –£–ø—Ä–æ—â–µ–Ω–∏–µ CLI –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã —á–µ—Ä–µ–∑ —á–µ—Ç–∫–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –Ω–∞ –¥–≤–∞ —Å–ª–æ—è –¥–∞–Ω–Ω—ã—Ö

## TL;DR

- **–î–≤–∞ —Å–ª–æ—è –¥–∞–Ω–Ω—ã—Ö:** FullProfile (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ) –∏ ClientConfig (–∞—Ä—Ç–µ—Ñ–∞–∫—Ç —ç–∫—Å–ø–æ—Ä—Ç–∞)
- **–î–≤–µ –≥—Ä—É–ø–ø—ã –∫–æ–º–∞–Ω–¥:** `profile` (—É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã–º–∏) –∏ `export` (–≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤)
- **–ß–µ—Ç–∫–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏:** –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ä–∞–±–æ—Ç–∞–µ—Ç —Å –ø—Ä–æ—Ñ–∏–ª—è–º–∏, —Å–∏—Å—Ç–µ–º–∞ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∫–æ–Ω—Ñ–∏–≥–∏
- **–£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ —Ç–µ—Ä–º–∏–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–π –ø—É—Ç–∞–Ω–∏—Ü—ã:** –Ω–µ—Ç —Å–º–µ—à–∏–≤–∞–Ω–∏—è "–ø—Ä–æ—Ñ–∏–ª–µ–π", "–∫–æ–Ω—Ñ–∏–≥–æ–≤", "—ç–∫—Å–ø–æ—Ä—Ç–æ–≤"

## –ö–æ–Ω—Ç–µ–∫—Å—Ç

–¢–µ–∫—É—â–∞—è CLI –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∏–º–µ–µ—Ç –ø—Ä–æ–±–ª–µ–º—ã:
- –ü—É—Ç–∞–Ω–∏—Ü–∞ –≤ —Ç–µ—Ä–º–∏–Ω–æ–ª–æ–≥–∏–∏: "–ø—Ä–æ—Ñ–∏–ª–∏", "–∫–æ–Ω—Ñ–∏–≥–∏", "—ç–∫—Å–ø–æ—Ä—Ç—ã" –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –≤ —Ä–∞–∑–Ω—ã—Ö –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞—Ö
- –ü–µ—Ä–µ–≥—Ä—É–∂–µ–Ω–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞ `export` —Å –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–º–∏ —Ñ–ª–∞–≥–∞–º–∏
- –°–º–µ—à–∏–≤–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö –∏ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤ —ç–∫—Å–ø–æ—Ä—Ç–∞
- –°–ª–æ–∂–Ω–æ—Å—Ç—å –ø–æ–Ω–∏–º–∞–Ω–∏—è –¥–ª—è –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

## –†–µ—à–µ–Ω–∏–µ

### 1. –î–≤—É—Ö—Å–ª–æ–π–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö

| –£—Ä–æ–≤–µ–Ω—å | –ß—Ç–æ —Ö—Ä–∞–Ω–∏—Ç | –§–∞–π–ª/—Ñ–æ—Ä–º–∞—Ç | –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ |
|---------|------------|-------------|---------------|
| **FullProfile** (–∏—Å—Ç–æ—á–Ω–∏–∫ –ø—Ä–∞–≤–¥—ã) | –í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ | `profile.toml`/`profile.yaml` | –†–µ–¥–∞–∫—Ç–æ—Ä, CI-—Å–∫—Ä–∏–ø—Ç—ã |
| **ClientConfig** (–∞—Ä—Ç–µ—Ñ–∞–∫—Ç —ç–∫—Å–ø–æ—Ä—Ç–∞) | –¢–æ–ª—å–∫–æ —Ç–æ, —á—Ç–æ –ø–æ–Ω–∏–º–∞–µ—Ç backend | `config.json` | sing-box, Docker, –º–æ–±–∏–ª—å–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç—ã |

**–ü—Ä–∞–≤–∏–ª–æ:** –í—Å–µ, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–¥–∞–µ—Ç —Ä—É–∫–∞–º–∏ ‚Üí FullProfile. –í—Å–µ, —á—Ç–æ –µ—Å—Ç —Å–æ—Ñ—Ç ‚Üí ClientConfig.

### 2. –î–≤–µ –≥—Ä—É–ø–ø—ã CLI –∫–æ–º–∞–Ω–¥

```
sboxctl profile  ‚Ä¶   # –æ–ø–µ—Ä–∏—Ä—É–µ–º –ø—Ä–æ—Ñ–∏–ª—è–º–∏ (—É—Ä–æ–≤–µ–Ω—å FullProfile)
sboxctl export   ‚Ä¶   # –ø–æ–ª—É—á–∞–µ–º/–≤–∞–ª–∏–º/—Ç–µ—Å—Ç–∏–º –∫–æ–Ω—Ñ–∏–≥ (—É—Ä–æ–≤–µ–Ω—å ClientConfig)
```

#### 2.1 `profile` ‚Äî —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏—Å—Ö–æ–¥–Ω–∏–∫–æ–º

| –ü–æ–¥–∫–æ–º–∞–Ω–¥–∞ | –ß—Ç–æ –¥–µ–ª–∞–µ—Ç |
|------------|------------|
| `list` | –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø—Ä–æ—Ñ–∏–ª–∏ (`home`, `work`, `router-lab`) |
| `show NAME` | –ø–µ—á–∞—Ç–∞–µ—Ç YAML/TOML —Ü–µ–ª–∏–∫–æ–º |
| `new NAME` | —Å–æ–∑–¥–∞–µ—Ç –±–æ–ª–≤–∞–Ω–∫—É |
| `edit NAME` | –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç $EDITOR (–∏–ª–∏ wizard) |
| `validate NAME` | –±—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ö–µ–º—ã |
| `set-active NAME` | –ø–æ–º–µ—á–∞–µ—Ç –ø—Ä–æ—Ñ–∏–ª—å ¬´–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é¬ª |

#### 2.2 `export` ‚Äî –ø–æ–ª—É—á–∞–µ–º/–ø—Ä–æ–≤–µ—Ä—è–µ–º –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã

| –ü–æ–¥–∫–æ–º–∞–Ω–¥–∞ | –ê—Ä—Ç–µ—Ñ–∞–∫—Ç | –¢–∏–ø–æ–≤–æ–π –≤—ã–∑–æ–≤ |
|------------|----------|---------------|
| `generate` | `config.json` | `sboxctl export generate --profile home --out /etc/sing-box/config.json` |
| `validate` | –ª—é–±–æ–π JSON | `sboxctl export validate /etc/sing-box/config.json` |
| `dry-run` | stdout | `sboxctl export dry-run --profile home` |
| `profile` | YAML/TOML –ø–æ—Å–ª–µ –ø–æ—Å—Ç-–æ–±—Ä–∞–±–æ—Ç–æ–∫ | `sboxctl export profile --profile home --out optimized.yaml` |

### 3. –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∫–æ–¥–µ

#### 3.1 –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –∫–ª–∞—Å—Å–æ–≤
```python
class FullProfile(BaseModel): ...  # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ
class ClientConfig(BaseModel): ... # –ê—Ä—Ç–µ—Ñ–∞–∫—Ç —ç–∫—Å–ø–æ—Ä—Ç–∞
```

#### 3.2 –ê–ª–∏–∞—Å—ã —Å –ø–æ–º–µ—Ç–∫–∞–º–∏ —É—Å—Ç–∞—Ä–µ–≤–∞–Ω–∏—è
```python
from typing_extensions import TypeAlias

UserConfig: TypeAlias = FullProfile  # TODO: remove after v1.0
```

#### 3.3 –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã
```python
# sboxmgr.constants
DEFAULT_USER_AGENT = "ClashMeta/1.0"
SUPPORTED_PROTOCOLS = {"vless", "shadowsocks", "vmess", "trojan"}
```

#### 3.4 –î–æ–∫—Å—Ç—Ä–∏–Ω–≥–∏ —Å–µ—Ä–≤–∏—Å–æ–≤
```python
def export_config(profile: FullProfile) -> ClientConfig:
    """Takes FullProfile, returns ClientConfig."""
```

## –ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è

### –ü–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–µ:
- ‚úÖ **–ß–µ—Ç–∫–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏** - –ø—Ä–æ—Ñ–∏–ª–∏ vs –∫–æ–Ω—Ñ–∏–≥–∏
- ‚úÖ **–£–ø—Ä–æ—â–µ–Ω–∏–µ UX** - –ª–æ–≥–∏—á–Ω–∞—è –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –∫–æ–º–∞–Ω–¥
- ‚úÖ **–£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –ø—É—Ç–∞–Ω–∏—Ü—ã** - –Ω–µ—Ç —Å–º–µ—à–∏–≤–∞–Ω–∏—è —Ç–µ—Ä–º–∏–Ω–æ–≤
- ‚úÖ **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å** - –ª–µ–≥–∫–æ –¥–æ–±–∞–≤–ª—è—Ç—å –Ω–æ–≤—ã–µ –∫–æ–º–∞–Ω–¥—ã
- ‚úÖ **–ü–æ–Ω—è—Ç–Ω–æ—Å—Ç—å –¥–ª—è –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π** - –∏–Ω—Ç—É–∏—Ç–∏–≤–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞

### –û—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–µ:
- ‚ùå **Breaking changes** - –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∫–æ–º–∞–Ω–¥
- ‚ùå **–°–ª–æ–∂–Ω–æ—Å—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏** - –Ω—É–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é –∏ –ø—Ä–∏–º–µ—Ä—ã
- ‚ùå **–í—Ä–µ–º–µ–Ω–Ω–∞—è –ø—É—Ç–∞–Ω–∏—Ü–∞** - –ø–µ—Ä–µ—Ö–æ–¥–Ω—ã–π –ø–µ—Ä–∏–æ–¥ —Å –∞–ª–∏–∞—Å–∞–º–∏

### –†–∏—Å–∫–∏:
- üî¥ **–ü–æ—Ç–µ—Ä—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞** - –ø—Ä–∏ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–µ –º–æ–≥—É—Ç –±—ã—Ç—å —É–ø—É—â–µ–Ω—ã –¥–µ—Ç–∞–ª–∏
- üî¥ **–°–ª–æ–∂–Ω–æ—Å—Ç—å —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è** - –Ω—É–∂–Ω–æ –ø–æ–∫—Ä—ã—Ç—å –Ω–æ–≤—ã–µ –∫–æ–º–∞–Ω–¥—ã

## –ú–∏–≥—Ä–∞—Ü–∏—è

### –≠—Ç–∞–ø 1: –°–æ–∑–¥–∞–Ω–∏–µ —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–π
- [ ] –°–æ–∑–¥–∞—Ç—å ADR-0020
- [ ] –û–±–Ω–æ–≤–∏—Ç—å —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏
- [ ] –°–æ–∑–¥–∞—Ç—å –ø–ª–∞–Ω –º–∏–≥—Ä–∞—Ü–∏–∏

### –≠—Ç–∞–ø 2: –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ –∫–æ–¥–∞
- [ ] –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å –∫–ª–∞—Å—Å—ã
- [ ] –°–æ–∑–¥–∞—Ç—å –∞–ª–∏–∞—Å—ã —Å –ø–æ–º–µ—Ç–∫–∞–º–∏ —É—Å—Ç–∞—Ä–µ–≤–∞–Ω–∏—è
- [ ] –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ CLI –∫–æ–º–∞–Ω–¥
- [ ] –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤

### –≠—Ç–∞–ø 3: –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- [ ] –û–±–Ω–æ–≤–∏—Ç—å help-—Ç–µ–∫—Å—Ç—ã
- [ ] –û–±–Ω–æ–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫—É—é –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é
- [ ] –°–æ–∑–¥–∞—Ç—å –ø—Ä–∏–º–µ—Ä—ã –º–∏–≥—Ä–∞—Ü–∏–∏

### –≠—Ç–∞–ø 4: –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å
- [ ] –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∞–ª–∏–∞—Å—ã –∫–æ–º–∞–Ω–¥
- [ ] –î–æ–±–∞–≤–∏—Ç—å deprecation warnings
- [ ] –ü–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å —É–¥–∞–ª–µ–Ω–∏–µ –≤ v1.0

## –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã

### –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ 1: –û—Å—Ç–∞–≤–∏—Ç—å —Ç–µ–∫—É—â—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É
- **–ü–ª—é—Å—ã:** –ù–µ—Ç breaking changes
- **–ú–∏–Ω—É—Å—ã:** –°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –ø—É—Ç–∞–Ω–∏—Ü–∞ –≤ —Ç–µ—Ä–º–∏–Ω–æ–ª–æ–≥–∏–∏

### –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ 2: –¢—Ä–µ—Ö—É—Ä–æ–≤–Ω–µ–≤–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞
- **–ü–ª—é—Å—ã:** –ë–æ–ª–µ–µ –¥–µ—Ç–∞–ª—å–Ω–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ
- **–ú–∏–Ω—É—Å—ã:** –£—Å–ª–æ–∂–Ω–µ–Ω–∏–µ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã

## –†–µ—à–µ–Ω–∏–µ

–ü—Ä–∏–Ω–∏–º–∞–µ–º –¥–≤—É—Ö—Å–ª–æ–π–Ω—É—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É –∫–∞–∫ –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å –º–µ–∂–¥—É –ø—Ä–æ—Å—Ç–æ—Ç–æ–π –∏ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å—é.

## –°–≤—è–∑–∞–Ω–Ω—ã–µ ADR

- **ADR-0017:** Full Profile Architecture (–æ–±–Ω–æ–≤–∏—Ç—å —Ç–µ—Ä–º–∏–Ω–æ–ª–æ–≥–∏—é)
- **ADR-0019:** Full Profile UX & Runtime Management (–∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥ –Ω–æ–≤—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É)
