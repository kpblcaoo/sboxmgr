# ADR-0006: Безопасная архитектура мультиязычности (i18n)

## Контекст

В проекте требуется поддержка мультиязычного CLI/wizard и документации. Языковые модули — новая точка расширения, потенциальный вектор атак (code injection, supply chain, log poisoning, DoS).

## Решение

- Использовать только декларативные форматы языковых файлов (`.json`, `.po`), никакого кода.
- Загрузка только из whitelisted путей (`src/sboxmgr/i18n/`).
- Валидация схемы (pydantic/jsonschema).
- Sanitization: удаление ANSI, ограничение длины, фильтрация подозрительных символов.
- Fail-safe fallback: если файл/ключ не найден — откат на английский.
- Метка о машинном переводе для не-ручных локалей.
- Покрытие тестами на инъекции, некорректные строки, DoS.
- **DX-дружественная архитектура**: все языковые плагины, валидаторы и генераторы реализованы через registry и CLI-генератор шаблонов (plugin-template).
- **Автоматизация автоперевода**: поддержка массового добавления языков с пометкой [AI], автоматическая генерация языковых файлов и их интеграция в CLI.
- **Двуязычный вывод**: при неявном выборе языка CLI выводит сообщения на двух языках (en + локальный), с явным уведомлением о режиме.
- **Интеграция в CI/pre-commit**: автоматическая проверка i18n-ключей, тесты на корректность языковых файлов, защита от ошибок и инъекций.

## Обоснование

- Предотвращение code injection через языковые файлы.
- Исключение supply chain атак (загрузка только из whitelisted путей).
- Защита от log poisoning и DoS через sanitization и fallback.
- Прозрачность для пользователей: метка о машинном переводе.
- DX: быстрое добавление новых языков и валидаторов, автоматизация тестов и документации.

## Последствия

- Требуется централизовать доступ к строкам через LanguageLoader.
- Все новые языки проходят SEC-анализ и тесты.
- Любой новый язык или валидатор добавляется через CLI-генератор и автоматически тестируется.

## Связанные документы
- docs/i18n.md
- docs/sec_checklist.md
- docs/tests/edge_cases.md 