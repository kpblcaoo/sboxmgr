# ADR-0020: Profile Runtime Semantics & Outbound Management

## –°—Ç–∞—Ç—É—Å

**–î–∞—Ç–∞:** 2025-07-01
**–°—Ç–∞—Ç—É—Å:** üîÑ **–í –†–ê–ó–†–ê–ë–û–¢–ö–ï**
**–ö–æ–Ω—Ç–µ–∫—Å—Ç:** Runtime —Å–µ–º–∞–Ω—Ç–∏–∫–∞ –ø—Ä–æ—Ñ–∏–ª–µ–π, —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ outbounds –∏ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–µ–π

## TL;DR

- **Outbounds –ù–ï —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –ø—Ä–æ—Ñ–∏–ª–µ** - —Ç–æ–ª—å–∫–æ OutboundPolicy –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
- **–ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è –∏–∑ –ø–æ–¥–ø–∏—Å–æ–∫** - —á–µ—Ä–µ–∑ RoutingPolicyBuilder —Å –¥–µ—Ñ–æ–ª—Ç–∞–º–∏
- **–ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ —Ö–µ—à–∞–º** - –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ pipeline
- **–í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ** - –≤ meta —Å–µ–∫—Ü–∏–∏ –ø—Ä–æ—Ñ–∏–ª—è
- **–ì–µ–æ—Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è** - –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è, –Ω–µ –∏—Å–∫–ª—é—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é

## –ö–æ–Ω—Ç–µ–∫—Å—Ç

–ù—É–∂–Ω–æ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å, –∫–∞–∫ –ø—Ä–æ—Ñ–∏–ª–∏ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤—É—é—Ç —Å –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–º–∏ –¥–∞–Ω–Ω—ã–º–∏ (–ø–æ–¥–ø–∏—Å–∫–∏, outbounds, –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è) –∏ –∫–∞–∫ –æ–±–µ—Å–ø–µ—á–∏—Ç—å —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å.

## –†–µ—à–µ–Ω–∏–µ

### 1. Outbound Management

#### Outbounds –ù–ï –≤ –ø—Ä–æ—Ñ–∏–ª–µ
```python
# ‚ùå –ù–ï –¥–µ–ª–∞–µ–º —Ç–∞–∫
class FullProfile(BaseModel):
    outbounds: List[OutboundConfig]  # –ù–ï–¢!

# ‚úÖ –î–µ–ª–∞–µ–º —Ç–∞–∫
class FullProfile(BaseModel):
    outbound_policy: OutboundPolicy
    routing_policy: RoutingPolicy
```

#### OutboundPolicy –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
```python
class OutboundPolicy(BaseModel):
    group_by: Literal["subscription", "country", "custom"] = "subscription"
    strategy: Literal["url_test", "random", "fallback", "geo"] = "url_test"
    include_tags: List[str] = []
    exclude_tags: List[str] = []
    max_per_group: int = 5
    deduplicate: bool = True
```

### 2. Routing from Subscriptions

#### –ü—Ä–∏–Ω—Ü–∏–ø: –¥–æ–≤–µ—Ä—è–π, –Ω–æ –ø—Ä–æ–≤–µ—Ä—è–π
```python
class RoutingPolicy(BaseModel):
    mode: Literal["manual", "auto"] = "auto"
    default_group: str = "auto"
    ruleset_strategy: Literal["geoip", "domain_suffix", "subscription_tags"] = "geoip"
    fallback_to_proxy: bool = True
    trust_subscription_rules: bool = False  # –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
```

#### Pipeline –æ–±—Ä–∞–±–æ—Ç–∫–∏
```
[–ü–æ–¥–ø–∏—Å–∫–∏] ‚Üí [–ü–∞—Ä—Å–∏–Ω–≥ ‚Üí ParsedServer[]]
                    |
               [Exclusions] ‚Üí ‚ùå –£–¥–∞–ª–∏—Ç—å
                    |
          [PostProcessorChain] ‚Üí üí° Geo/Latency/Dedup
                    |
            [OutboundPolicyBuilder]
                    |
           [RoutingPolicyBuilder] ‚Üí Rules
                    |
            [FinalConfigExporter]
```

### 3. Caching & Change Detection

#### –•–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ —Ä–∞–∑–Ω—ã—Ö —É—Ä–æ–≤–Ω—è—Ö
```python
class ProfileMetadata(BaseModel):
    generated_by: str = "sboxmgr"
    sboxmgr_version: str
    profile_schema_version: str = "1.0.0"
    timestamp: datetime
    cache_hashes: Dict[str, str] = {}  # source_url -> hash
```

#### –ö–µ—à-—Ö–µ—à–∏
- `raw_hash` - —Ö–µ—à —Å—ã—Ä–æ–π –ø–æ–¥–ø–∏—Å–∫–∏
- `parsed_hash` - —Ö–µ—à ParsedServer[]
- `outbounds_hash` - —Ö–µ—à —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö outbounds
- `routing_hash` - —Ö–µ—à routing rules

### 4. Geo Filtering Policy

#### –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –ø–æ–¥—Ö–æ–¥
```python
class GeoFilterPolicy(BaseModel):
    exclude_geo: List[str] = []  # –ü—É—Å—Ç–æ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    warn_geo: List[str] = ["CN"]  # –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è
    warn_message: str = "‚ö†Ô∏è Server in {country}. May be fake/trap."
```

#### UX –ø—Ä–∏–Ω—Ü–∏–ø—ã
- ‚ùå –ù–ï –∏—Å–∫–ª—é—á–∞—Ç—å CN –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
- ‚úÖ –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è
- ‚úÖ –î–∞–≤–∞—Ç—å –æ–ø—Ü–∏—é `--exclude-geo CN`
- ‚úÖ –û–±—ä—è—Å–Ω—è—Ç—å –≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏

### 5. Versioning Strategy

#### Meta —Å–µ–∫—Ü–∏—è –≤ –ø—Ä–æ—Ñ–∏–ª–µ
```json
{
  "meta": {
    "generated_by": "sboxmgr",
    "sboxmgr_version": "1.5.0",
    "profile_schema_version": "1.0.0",
    "timestamp": "2025-07-01T12:00:00Z",
    "cache_hashes": {
      "https://sub.example.com": "sha256:abc123..."
    }
  }
}
```

#### –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –ì–¥–µ –≤–µ—Ä—Å–∏—è | –ü—Ä–∏–º–µ—Ä |
|-----------|------------|--------|
| sboxmgr | meta.sboxmgr_version | 1.5.0 |
| Profile Schema | meta.profile_schema_version | 1.0.0 |
| sing-box | meta.singbox_version | 1.8.9 |
| Plugins | plugins/*/manifest.json | 1.0.0 |

## –ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è

### –ü–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–µ:
- ‚úÖ **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å** - –Ω–µ –¥–æ–≤–µ—Ä—è–µ–º –º–∞—Ä—à—Ä—É—Ç–∞–º –∏–∑ –ø–æ–¥–ø–∏—Å–æ–∫
- ‚úÖ **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å** - –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ —Ö–µ—à–∞–º
- ‚úÖ **–ì–∏–±–∫–æ—Å—Ç—å** - –ø–æ–ª–∏—Ç–∏–∫–∏ –≤–º–µ—Å—Ç–æ —Ö–∞—Ä–¥–∫–æ–¥–∞
- ‚úÖ **–í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ** - –ø–æ–ª–Ω–∞—è —Ç—Ä–∞—Å—Å–∏—Ä—É–µ–º–æ—Å—Ç—å
- ‚úÖ **UX** - –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –≤–º–µ—Å—Ç–æ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏

### –û—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–µ:
- ‚ùå **–°–ª–æ–∂–Ω–æ—Å—Ç—å** - –±–æ–ª—å—à–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
- ‚ùå **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å** - –≤—ã—á–∏—Å–ª–µ–Ω–∏–µ —Ö–µ—à–µ–π
- ‚ùå **–†–∞–∑–º–µ—Ä** - meta —Å–µ–∫—Ü–∏—è —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç –ø—Ä–æ—Ñ–∏–ª–∏

### –†–∏—Å–∫–∏:
- üî¥ **–ö–µ—à-–∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è** - –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ —Ö–µ—à–∏
- üî¥ **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å** - –ª–æ–∂–Ω—ã–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è
- ‚ö†Ô∏è **UX** - —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π

## –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã

### A. –•—Ä–∞–Ω–∏—Ç—å outbounds –≤ –ø—Ä–æ—Ñ–∏–ª–µ
- ‚ùå –†–∞–∑–º–µ—Ä –ø—Ä–æ—Ñ–∏–ª–µ–π
- ‚ùå –†–∞—Å—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å –ø–æ–¥–ø–∏—Å–∫–∞–º–∏
- ‚ùå –°–ª–æ–∂–Ω–æ—Å—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è

### B. –î–æ–≤–µ—Ä—è—Ç—å –º–∞—Ä—à—Ä—É—Ç–∞–º –∏–∑ –ø–æ–¥–ø–∏—Å–æ–∫
- ‚ùå –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
- ‚ùå –ö–æ–Ω—Ç—Ä–æ–ª—å –Ω–∞–¥ routing

### C. –ò—Å–∫–ª—é—á–∞—Ç—å CN –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
- ‚ùå UX (–º–æ–∂–µ—Ç –æ–±–∏–¥–µ—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)
- ‚ùå –ü–æ—Ç–µ—Ä—è –≤–∞–ª–∏–¥–Ω—ã—Ö —Å–µ—Ä–≤–µ—Ä–æ–≤

## –†–µ–∞–ª–∏–∑–∞—Ü–∏—è

### Phase 1: Foundation
- [ ] –°–æ–∑–¥–∞—Ç—å OutboundPolicy –∏ RoutingPolicy –º–æ–¥–µ–ª–∏
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å ProfileMetadata —Å –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º
- [ ] –î–æ–±–∞–≤–∏—Ç—å –∫–µ—à-—Ö–µ—à–∏ –≤ pipeline

### Phase 2: Integration
- [ ] –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º–∏
- [ ] –î–æ–±–∞–≤–∏—Ç—å GeoFilterPolicy
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –≤ CLI

### Phase 3: Advanced
- [ ] –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è
- [ ] GUI –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π
- [ ] SaaS –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è

## –°–≤—è–∑–∞–Ω–Ω—ã–µ ADR

- ADR-0017: Full Profile Architecture
- ADR-0019: Full Profile UX & Runtime Management
- ADR-0016: Pydantic Schema Generation
- ADR-0008: Defaults and Fail-Tolerance
