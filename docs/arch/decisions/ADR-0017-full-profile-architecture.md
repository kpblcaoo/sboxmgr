# ADR-0017: Full Profile Architecture

## –°—Ç–∞—Ç—É—Å

**–î–∞—Ç–∞:** 2025-06-29
**–°—Ç–∞—Ç—É—Å:** ‚úÖ **–ü–†–ò–ù–Ø–¢–û**
**–ö–æ–Ω—Ç–µ–∫—Å—Ç:** –ï–¥–∏–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω–∞—è —Å—É—â–Ω–æ—Å—Ç—å –¥–ª—è –≤—Å–µ–≥–æ –ø–∞–π–ø–ª–∞–π–Ω–∞

## TL;DR

- **FullProfile** = –µ–¥–∏–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω–∞—è —Å—É—â–Ω–æ—Å—Ç—å, –æ—Ö–≤–∞—Ç—ã–≤–∞—é—â–∞—è –≤—Å–µ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ)
- **ClientConfig** = –∞—Ä—Ç–µ—Ñ–∞–∫—Ç —ç–∫—Å–ø–æ—Ä—Ç–∞, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–Ω–∏–º–∞–µ—Ç backend (sing-box, Docker, –º–æ–±–∏–ª—å–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç—ã)
- **profile.toml/yaml** —Å–æ–¥–µ—Ä–∂–∏—Ç: –ø–æ–¥–ø–∏—Å–∫–∏, –º–∞—Ä—à—Ä—É—Ç—ã, —Ñ–∏–ª—å—Ç—Ä—ã, —ç–∫—Å–ø–æ—Ä—Ç, –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–≥–µ–Ω—Ç–∞, UI
- **CLI –∫–æ–º–∞–Ω–¥—ã:** `sboxctl profile apply profiles/home.toml` –∏ `sboxctl export generate --profile home`
- **SaaS-ready:** –ø—Ä–æ—Ñ–∏–ª–∏ –ª–µ–≥–∫–æ —Å–µ—Ä–∏–∞–ª–∏–∑—É—é—Ç—Å—è –≤ –ë–î/–æ–±–ª–∞–∫–æ
- **–†–µ—à–∞–µ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç UI/CLI:** –ø—Ä–æ—Ñ–∏–ª—å –∫–∞–∫ –µ–¥–∏–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã
- **–î–≤—É—Ö—Å–ª–æ–π–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:** FullProfile (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ) ‚Üí ClientConfig (–∞—Ä—Ç–µ—Ñ–∞–∫—Ç —ç–∫—Å–ø–æ—Ä—Ç–∞)

## –ö–æ–Ω—Ç–µ–∫—Å—Ç

–¢–µ–∫—É—â–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∏–º–µ–µ—Ç —Ä–∞–∑—Ä–æ–∑–Ω–µ–Ω–Ω—ã–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:
- `config.json` - –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ CLI
- `exclusions.json` - –∏—Å–∫–ª—é—á–µ–Ω–∏—è —Å–µ—Ä–≤–µ—Ä–æ–≤
- `subscriptions.yaml` - –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –ø–æ–¥–ø–∏—Å–æ–∫
- –†–∞–∑–ª–∏—á–Ω—ã–µ CLI —Ñ–ª–∞–≥–∏ –¥–ª—è –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏ –∏ —ç–∫—Å–ø–æ—Ä—Ç–∞

–≠—Ç–æ —Å–æ–∑–¥–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—ã:
- –°–ª–æ–∂–Ω–æ—Å—Ç—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–º–∏ —Ñ–∞–π–ª–∞–º–∏
- –ö–æ–Ω—Ñ–ª–∏–∫—Ç—ã –º–µ–∂–¥—É UI –∏ CLI –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏
- –°–ª–æ–∂–Ω–æ—Å—Ç—å –¥–ª—è SaaS (–º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ —Å—É—â–Ω–æ—Å—Ç–∏ –≤ –ë–î)
- –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –µ–¥–∏–Ω–æ–π —Ç–æ—á–∫–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

## –†–µ—à–µ–Ω–∏–µ

### 1. Full Profile –∫–∞–∫ –µ–¥–∏–Ω–∞—è —Å—É—â–Ω–æ—Å—Ç—å

```json
{
  "id": "home",
  "description": "–î–æ–º–∞—à–Ω–∏–π –ø—Ä–æ—Ñ–∏–ª—å —Å Pi-hole, VPN –∏ –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º –æ–±—Ö–æ–¥–æ–º",
  "subscriptions": [
    "https://sub.example.com/vless",
    "local/ss.json"
  ],
  "filters": {
    "exclude_tags": ["ads", "test"],
    "only_tags": ["trusted"],
    "exclusions": ["server1", "server2"]
  },
  "routing": {
    "proxy1.example.com": "tunnel",
    "proxy2.example.com": "direct",
    "default_route": "tunnel"
  },
  "export": {
    "format": "sing-box",
    "outbound_profile": "vless-real",
    "inbound_profile": "tun",
    "output_file": "config.json"
  },
  "middleware": ["TagFilter", "EnrichGeo", "RouteByLatency"],
  "agent": {
    "auto_restart": false,
    "monitor_latency": true,
    "health_check_interval": "30s"
  },
  "ui": {
    "default_language": "ru",
    "mode": "tui"
  }
}
```

### 2. CLI –∫–æ–º–∞–Ω–¥—ã (–æ–±–Ω–æ–≤–ª–µ–Ω–æ —Å–æ–≥–ª–∞—Å–Ω–æ ADR-0020)

```bash
# –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è–º–∏ (FullProfile)
sboxctl profile list                    # —Å–ø–∏—Å–æ–∫ –ø—Ä–æ—Ñ–∏–ª–µ–π
sboxctl profile show home              # –ø–æ–∫–∞–∑–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å
sboxctl profile new work               # —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –ø—Ä–æ—Ñ–∏–ª—å
sboxctl profile edit home              # —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å
sboxctl profile validate home          # –≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å
sboxctl profile set-active home        # —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å

# –≠–∫—Å–ø–æ—Ä—Ç –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤ (ClientConfig)
sboxctl export generate --profile home --out config.json
sboxctl export validate config.json
sboxctl export dry-run --profile home
sboxctl export profile --profile home --out optimized.yaml
```

### 3. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º–∏

#### –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å
- –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ñ–∞–π–ª—ã (`exclusions.json`, `config.json`) –ø—Ä–æ–¥–æ–ª–∂–∞—é—Ç —Ä–∞–±–æ—Ç–∞—Ç—å
- CLI —Ñ–ª–∞–≥–∏ –∏–º–µ—é—Ç –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –Ω–∞–¥ –ø—Ä–æ—Ñ–∏–ª–µ–º
- –ü–æ—Å—Ç–µ–ø–µ–Ω–Ω–∞—è –º–∏–≥—Ä–∞—Ü–∏—è —á–µ—Ä–µ–∑ `--profile` —Ñ–ª–∞–≥

#### –ú–∏–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π –ø—É—Ç—å
```bash
# –°—Ç–∞—Ä—ã–π —Å–ø–æ—Å–æ–± (–ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å)
sboxctl export -u https://sub.example.com

# –ù–æ–≤—ã–π —Å–ø–æ—Å–æ–± (—Å–æ–≥–ª–∞—Å–Ω–æ ADR-0020)
sboxctl profile apply profiles/home.toml
sboxctl export generate --profile home

# –ì–∏–±—Ä–∏–¥–Ω—ã–π —Å–ø–æ—Å–æ–±
sboxctl export generate --profile home --override-subscription https://new-sub.example.com
```

### 4. SaaS –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è

#### –ú–æ–¥–µ–ª—å –≤ –ë–î
```json
{
  "user_id": "u_123",
  "profile_id": "home-vpn",
  "active": true,
  "created_at": "2025-07-03T10:00:00Z",
"updated_at": "2025-07-03T15:30:00Z",
  "data": { ... } // embedded full profile
}
```

#### API endpoints
- `GET /api/users/{user_id}/profiles` - —Å–ø–∏—Å–æ–∫ –ø—Ä–æ—Ñ–∏–ª–µ–π
- `POST /api/users/{user_id}/profiles` - —Å–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è
- `PUT /api/users/{user_id}/profiles/{profile_id}` - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
- `POST /api/users/{user_id}/profiles/{profile_id}/apply` - –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ

## –ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è

### –ü–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–µ:
- ‚úÖ **–¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–∞—Ü–∏—è** - –æ–¥–∏–Ω JSON ‚Üí –≤—Å–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
- ‚úÖ **–ü—Ä–æ—Å—Ç–æ–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ** - `sboxmgr apply --profile home.json`
- ‚úÖ **A/B —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ** - –ø—Ä–æ—Ñ–∏–ª–∏: home, work, vpn-only, ci-test
- ‚úÖ **–£–¥–æ–±—Å—Ç–≤–æ –¥–ª—è UI** - –æ–¥–∏–Ω YAML/JSON —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç –≤—Å—é –ø–∞–Ω–µ–ª—å
- ‚úÖ **SaaS-ready** - –ø—Ä–æ—Ñ–∏–ª–∏ –ª–µ–≥–∫–æ —Å–µ—Ä–∏–∞–ª–∏–∑—É—é—Ç—Å—è –≤ –ë–î/–æ–±–ª–∞–∫–æ
- ‚úÖ **–†–µ—à–∞–µ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç UI/CLI** - –ø—Ä–æ—Ñ–∏–ª—å –∫–∞–∫ –µ–¥–∏–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã
- ‚úÖ **–í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ** - –ø—Ä–æ—Ñ–∏–ª–∏ –º–æ–∂–Ω–æ —Ö—Ä–∞–Ω–∏—Ç—å –≤ Git

### –û—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–µ:
- ‚ùå **–°–ª–æ–∂–Ω–æ—Å—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏** - –Ω—É–∂–Ω–æ –ø–µ—Ä–µ–≤–µ—Å—Ç–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∫–æ–Ω—Ñ–∏–≥–∏
- ‚ùå **–†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–æ–≤** - –ø—Ä–æ—Ñ–∏–ª–∏ –º–æ–≥—É—Ç –±—ã—Ç—å –±–æ–ª—å—à–∏–º–∏
- ‚ùå **–í–∞–ª–∏–¥–∞—Ü–∏—è** - —Å–ª–æ–∂–Ω–æ—Å—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –≤–ª–æ–∂–µ–Ω–Ω—ã—Ö —Å—Ç—Ä—É–∫—Ç—É—Ä
- ‚ùå **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å** - –∑–∞–≥—Ä—É–∑–∫–∞ –±–æ–ª—å—à–∏—Ö –ø—Ä–æ—Ñ–∏–ª–µ–π

### –†–∏—Å–∫–∏:
- üî¥ **–†–∞—Å—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è** - –ø—Ä–æ—Ñ–∏–ª—å vs –æ—Ç–¥–µ–ª—å–Ω—ã–µ —Ñ–∞–π–ª—ã
- üî¥ **–°–ª–æ–∂–Ω–æ—Å—Ç—å –æ—Ç–ª–∞–¥–∫–∏** - –≥–¥–µ –∏–º–µ–Ω–Ω–æ –ø—Ä–æ–±–ª–µ–º–∞ –≤ –±–æ–ª—å—à–æ–º –ø—Ä–æ—Ñ–∏–ª–µ
- ‚ö†Ô∏è **–û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å** - –Ω—É–∂–Ω–æ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å —Å—Ç–∞—Ä—ã–µ —Å–ø–æ—Å–æ–±—ã

## –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã

### A. –û—Å—Ç–∞–≤–∏—Ç—å —Ç–µ–∫—É—â—É—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É
- ‚ùå –°–ª–æ–∂–Ω–æ—Å—Ç—å –¥–ª—è SaaS
- ‚ùå –ö–æ–Ω—Ñ–ª–∏–∫—Ç—ã UI/CLI
- ‚ùå –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

### B. –¢–æ–ª—å–∫–æ –¥–ª—è SaaS
- ‚ùå –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏–∫–∏
- ‚ùå –†–∞–∑–Ω—ã–µ –ø–æ–¥—Ö–æ–¥—ã –¥–ª—è CLI –∏ SaaS

### C. –ú–∏–∫—Ä–æ-–ø—Ä–æ—Ñ–∏–ª–∏
- ‚ùå –°–ª–æ–∂–Ω–æ—Å—Ç—å –∫–æ–º–ø–æ–∑–∏—Ü–∏–∏
- ‚ùå –ü–æ—Ç–µ—Ä—è —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–∞—Ü–∏–∏

## –†–µ–∞–ª–∏–∑–∞—Ü–∏—è

### Phase 1: Foundation
- [ ] –°–æ–∑–¥–∞—Ç—å Pydantic –º–æ–¥–µ–ª–∏ –¥–ª—è Profile
- [ ] –°–æ–∑–¥–∞—Ç—å schema –¥–ª—è profile.json
- [ ] –ë–∞–∑–æ–≤—ã–µ CLI –∫–æ–º–∞–Ω–¥—ã: apply, validate, explain
- [ ] –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏ —Ñ–∞–π–ª–∞–º–∏

### Phase 2: Integration
- [ ] –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º–∏
- [ ] –ú–∏–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —É—Ç–∏–ª–∏—Ç—ã
- [ ] –¢–µ—Å—Ç—ã –¥–ª—è –≤—Å–µ—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤
- [ ] –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –∏ –ø—Ä–∏–º–µ—Ä—ã

### Phase 3: Advanced Features
- [ ] Diff –º–µ–∂–¥—É –ø—Ä–æ—Ñ–∏–ª—è–º–∏
- [ ] –≠–∫—Å–ø–æ—Ä—Ç —á–∞—Å—Ç–µ–π –ø—Ä–æ—Ñ–∏–ª—è
- [ ] –®–∞–±–ª–æ–Ω—ã –ø—Ä–æ—Ñ–∏–ª–µ–π
- [ ] SaaS –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è

## –°–≤—è–∑–∞–Ω–Ω—ã–µ ADR

- ADR-0003: Subscription Models & Normalization
- ADR-0005: Extensible Routing Layer
- ADR-0009: Configuration System Architecture
- ADR-0015: Agent-Installer Separation & Installation Strategy
- ADR-0016: Pydantic as Single Source of Truth for Validation and Schema Generation
- **ADR-0020:** CLI Command Structure - Two-Layer Architecture (–æ–±–Ω–æ–≤–ª—è–µ—Ç CLI –∫–æ–º–∞–Ω–¥—ã)
