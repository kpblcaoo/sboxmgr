# Архитектура и безопасность мультиязычности (i18n)

## Цели
- Поддержка мультиязычного CLI/wizard и документации.
- Безопасная загрузка языковых файлов без возможности code injection, supply chain, log poisoning, DoS.

## Формат языковых файлов
- Только декларативные форматы: `.json`, `.po` (gettext).
- Никакого кода, только ключ-значение.
- Пример:
```json
{
  "wizard.start": "Добро пожаловать в мастер настройки",
  "wizard.exit": "Выход"
}
```

## Безопасная загрузка
- Загрузка только из whitelisted путей (`src/sboxmgr/i18n/`).
- Валидация схемы (pydantic/jsonschema).
- Sanitization: удаление ANSI, ограничение длины, фильтрация подозрительных символов.
- Fail-safe fallback: если файл/ключ не найден — откат на английский.
- Метка о машинном переводе для не-ручных локалей.

## Процесс добавления языков
- Новый язык — PR с `.json`-файлом и меткой о машинном переводе (если не ручной).
- Автоматизация перевода — через CI/CD (deepl, googletrans и др.).
- Исключение машинных языков из проверки PR.

## Тесты
- Юнит-тесты на загрузку, ошибки, инъекции, длинные строки, fallback, метку о машинном переводе.

## Связанные документы
- ADR-XXXX: Безопасная архитектура мультиязычности (i18n)
- docs/sec_checklist.md
- docs/tests/edge_cases.md

## Безопасность автоматизации i18n (sync_keys.py)

### Потенциальные угрозы
- Path traversal: попытка подменить путь к языковым файлам через --lang-dir.
- Инъекции: внедрение вредоносных ключей/значений при автозаполнении.
- DoS: автогенерация огромного количества ключей (например, через ошибочный парсер).
- Supply chain: подмена или внедрение вредоносных шаблонов через PR/CI.
- Потеря переводов: случайное удаление или перезапись существующих ключей при автосинхронизации.
- Race condition: одновременное редактирование языковых файлов и запуск sync_keys.py.

### Меры защиты
- Валидация путей (--lang-dir только внутри репозитория).
- Проверка формата ключей (только допустимые символы, длина).
- Логирование всех изменений (diff до и после sync).
- Режим --check-only для CI (без автозаписи).
- Ручная проверка шаблонов (i18n/.template.json) перед мержем.
- Покрытие тестами: парсинг, diff, автозаполнение, edge-cases.
- Документировать процесс review для PR с изменениями i18n.

### Связанные чеклисты
- [ ] SEC-13: Безопасная автоматизация i18n (sync_keys.py) 