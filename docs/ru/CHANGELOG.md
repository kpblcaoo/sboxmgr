# История изменений

## Другие языки / Other languages
- [English (../CHANGELOG.md)](../CHANGELOG.md)

# pre-mvp0.1.0 (2025-07-03)

## Добавлено
- **Архитектура полных профилей**: Полная система профилей с моделями Pydantic (ADR-0017)
  - Команды `sboxmgr profile apply/validate/explain/diff/list/switch`
  - Модели FullProfile, SubscriptionProfile, FilterProfile, RoutingProfile
  - Поддержка ExportProfile, AgentProfile, UIProfile, LegacyProfile
  - 8 новых JSON-схем для валидации профилей
  - Примеры профилей в `examples/profiles/`
- **Фреймворк политик и безопасности**: Комплексная система политик безопасности (Фаза 5)
  - EncryptionPolicy, ProtocolPolicy, AuthenticationPolicy
  - GeoTestPolicy, CountryPolicy, ASNPolicy
  - IntegrityPolicy, PermissionPolicy, LimitPolicy
  - Оценка политик с детальным логированием и метаданными
- **Очистка агента**: Полный рефакторинг архитектуры агента (Фаза 2-3)
  - Удалено управление сервисами из агента (ADR-0015)
  - Разделение агента и установщика для чистой архитектуры
  - Генерация схем Pydantic (ADR-0016)
- **Миграция на Pydantic**: Значительные улучшения типобезопасности (Фаза 1)
  - Обширные улучшения аннотаций типов по всему коду
  - Исправлены критические ошибки типов в CLI, парсерах и фетчерах
  - Улучшена типобезопасность для основных модулей и экспортеров
- **Улучшения CLI**: Улучшенный пользовательский опыт и функциональность
  - Автоопределение формата подписки в list-servers
  - Надежный SingBoxParser с комплексной поддержкой форматов
  - Опция `--format` для принудительного определения формата
  - Улучшения UX: скрытие служебных outbound'ов, лучшее логирование User-Agent
- **Улучшения маршрутизации**: Улучшенный DefaultRouter с правилами fallback
  - Исправлен мертвый код в DefaultRouter
  - Добавлено правило fallback маршрутизации для оставшегося трафика
  - Комплексные тесты маршрутизации и валидация

## Изменено
- **Управление профилями**: Новый унифицированный подход к конфигурации
  - Единый JSON-профиль заменяет множественные файлы конфигурации
  - Обратная совместимость с существующими CLI-командами
  - Постепенный путь миграции от устаревшей конфигурации
- **Валидация безопасности**: Улучшенная оценка политик
  - Оценка политик в реальном времени с детальной отчетностью
  - Отслеживание нарушений политик, предупреждений и информации
  - Интеграция с пайплайном подписок
- **Система типов**: Улучшенные аннотации типов и валидация
  - Лучшие сообщения об ошибках для валидации типов
  - Улучшенная интеграция с моделями Pydantic
  - Улучшенная типобезопасность во всех модулях

## Исправлено
- **DefaultRouter**: Исправлен мертвый код и улучшена логика fallback
  - Вычисление тегов серверов теперь правильно используется в маршрутизации
  - Правила fallback корректно обрабатывают граничные случаи
  - Все тесты маршрутизации проходят с правильной генерацией правил
- **CLI UX**: Исправлены проблемы пользовательского опыта
  - Служебные outbound'ы (urltest/auto) скрыты из вывода list-servers
  - Лучшее логирование User-Agent (показывает реальные значения вместо [default])
  - Улучшенная обработка ошибок и валидация
- **Стабильность тестов**: Исправлены проблемы интеграционных тестов
  - Комплексная очистка тестов и предотвращение загрязнения config.json
  - Исправлены CLI matrix-тесты для сценариев с реальными данными
  - Улучшена изоляция и надежность тестов

## Технические детали
- **Архитектура**: Полная система профилей с валидацией Pydantic
- **Обратная совместимость**: Существующие рабочие процессы продолжают работать
- **Производительность**: Нет значительного влияния на существующие операции
- **Документация**: Комплексная документация ADR (0017-0019)
- **Типобезопасность**: Значительные улучшения в аннотациях типов
- **Система политик**: Комплексный фреймворк оценки безопасности
- **Покрытие тестами**: Улучшенное покрытие интеграционными и модульными тестами

## Примечания по миграции
- Существующие CLI-команды продолжают работать без изменений
- Новая система профилей опциональна и аддитивна
- Рекомендуется постепенная миграция на профили для сложных конфигураций
- Система политик обеспечивает улучшенную валидацию безопасности

---

# 1.5.0 (2025-07-01)

## Добавлено
- **CLI параметры входящих соединений**: Добавлены комплексные CLI-параметры для конфигурации входящих соединений в команде export
  - `--inbound-types`: Указание типов входящих соединений (tun, socks, http, tproxy)
  - `--tun-address`, `--tun-mtu`, `--tun-stack`: Конфигурация TUN-интерфейса
  - `--socks-port`, `--socks-listen`, `--socks-auth`: Конфигурация SOCKS-прокси
  - `--http-port`, `--http-listen`, `--http-auth`: Конфигурация HTTP-прокси
  - `--tproxy-port`, `--tproxy-listen`: Конфигурация TPROXY
  - `--dns-mode`: Режим разрешения DNS (system, tunnel, off)
- **Класс InboundBuilder**: Динамическое создание ClientProfile из CLI-параметров
- **Улучшенная валидация**: Валидация диапазонов портов, адресов, форматов
- **Улучшенный UX**: Нет необходимости создавать JSON-профили вручную для простых конфигураций входящих соединений
- **Разделение агента и установщика**: Реализация ADR-0015 для чистого разделения ответственности
- **Генерация схем Pydantic**: Реализация ADR-0016 для автоматической генерации схем
- **Аудит аннотаций типов**: Полные улучшения типобезопасности во всех модулях
- **CLI matrix-тестирование**: Комплексное тестирование поведения CLI с реальными данными
- **Система событий**: Комплексная система событий для операций sboxmgr
- **Мост агента**: Реализация IPC-протокола для будущей интеграции sboxagent

## Изменено
- **Команда export**: Улучшена поддержкой параметров входящих соединений при сохранении обратной совместимости
- **SingBox Exporter**: Обновлен для использования поля `listen_port` вместо `port` для лучшей совместимости
- **Покрытие тестами**: Добавлено 41 новых тестов (25 модульных + 16 интеграционных) для функциональности входящих соединений
- **Реорганизация CLI**: Полный рефакторинг CLI с новой структурой команды export
- **Реализация DefaultRouter**: Улучшенная маршрутизация с правилами fallback и улучшенной логикой
- **Управление исключениями**: Надежная обработка ошибок и механизмы восстановления файлов
- **Система логирования**: Улучшенная инициализация и обработка ошибок
- **Система конфигурации**: Улучшенная валидация и обработка ошибок

## Исправлено
- **Edge-case тесты**: Исправлены проблемы совместимости с новыми именами полей входящих соединений
- **Валидация**: Правильная обработка ошибок для невалидных типов входящих соединений и параметров
- **Безопасность**: Валидация адресов предотвращает небезопасные конфигурации привязки
- **Критические проблемы типов**: Исправлены все ошибки аннотаций типов по всему коду
- **Удаление мертвого кода**: Устранен неиспользуемый код и улучшено качество кода
- **Баг с аргументом контекста**: Исправлена обработка контекста в цепочке постпроцессоров
- **Обход валидации**: Исправлены критические проблемы обхода валидации Pydantic
- **Обработка ошибок CLI**: Улучшены сообщения об ошибках и обработка исключений
- **Стабильность тестов**: Исправлены 23 регрессии тестов после интеграции системы событий

## Технические детали
- **Архитектура**: Чистое разделение между CLI-параметрами и основной логикой
- **Обратная совместимость**: Существующие JSON-профили продолжают работать
- **Производительность**: Нет значительного влияния на производительность export
- **Документация**: Комплексные примеры и архитектурная документация
- **Типобезопасность**: 100% покрытие аннотаций типов с соответствием mypy
- **Система событий**: Комплексная обработка событий с поддержкой middleware
- **IPC-протокол**: Надежная сокет-основанная коммуникация для интеграции агента
- **Тестовая инфраструктура**: Комплексное CLI matrix-тестирование с реальными данными

## Примечания по миграции
- Существующие рабочие процессы продолжают работать без изменений
- Новые CLI-параметры опциональны и аддитивны
- JSON-профили могут быть постепенно мигрированы на CLI-параметры

---

# 1.4.0 (2025-06-20)

## Добавлено
- Полный рефакторинг CLI: переход на Typer для современной, модульной архитектуры.
- Все сценарии CLI (run, dry-run, exclusions, list-servers, clear-exclusions) реализованы как отдельные команды с единой логикой.
- Централизованное логирование (utils/logging.py), atomic file write и управление переменными окружения (utils/env.py).
- Добавлен .env.example со всеми поддерживаемыми переменными окружения.
- Entry point: CLI доступен как `sboxctl` после установки.
- CLI matrix-тесты: покрыты все сценарии, tolerant-поиск вывода.
- Новые onboarding и usage-примеры в документации.

## Изменено
- Вся бизнес-логика вынесена из CLI-обёрток в core-модули.
- CLI-обёртки теперь максимально тонкие (только orchestration).
- Структура каталогов приведена к best practice: cli/, core/, utils/, tests/.
- Все пути к артефактам (config, log, exclusions и др.) управляются через переменные окружения.
- Dev-зависимости вынесены в pyproject.toml (`pip install .[dev]`).
- Документация (README, DEVELOPMENT, TESTING, ru/) полностью обновлена и унифицирована.

## Исправлено
- Все тесты изолированы от .env и глобального окружения.
- Исправлены edge-case баги с exclusions, selected_config.json, возвратом сервера.
- Улучшена обработка ошибок для невалидных/пустых URL (всегда код возврата 1).
- Устранены DeprecationWarning (datetime и др.).

## Удалено
- requirements.txt удалён, все зависимости теперь только в pyproject.toml (PEP 621).
- Удалены все дублирующие, устаревшие и legacy-функции.
- Старые флаги и паттерны CLI объявлены deprecated.

## Breaking changes
- CLI полностью переведён на Typer: старые флаги/команды могут не работать.
- requirements.txt удалён, используйте только pyproject.toml.
- Все пути к артефактам теперь только через переменные окружения.
- CLI теперь только через `sboxctl` (entry point).

## Migration notes
- Скопируйте `.env.example` в `.env` и отредактируйте при необходимости.
- Для разработки используйте `pip install .[dev]`, для пользователей — `pip install .`.
- См. обновлённый README.md и usage-примеры для новых CLI-команд.

## Lessons learned
- Централизованное логирование и env значительно повышают поддерживаемость и тестируемость.
- Тонкие CLI-обёртки и модульная core-логика ускоряют рефакторинг и тестирование.
- Полная изоляция тестов и CLI matrix обеспечивают надёжное покрытие.
- Документирование lessons и архитектуры помогает будущим контрибьюторам.

## [1.3.1] — 2025-05-15

### Добавлено
- Полная автоматизация тестирования CLI: exclusions, clear-exclusions, идемпотентность, обработка ошибок, user-friendly сообщения, dry-run, selected_config.json, --list-servers, выбор excluded.
- User-friendly обработка ошибок при невалидном URL, повреждённом exclusions.json, попытке выбрать excluded сервер.
- Логирование ключевых CLI-действий и ошибок.

### Изменено
- exclusions.json теперь хранит только SHA256-хеши id, а для пользователя — человекочитаемое поле name.
- selected_config.json не создаётся и не изменяется в режиме --dry-run.
- Улучшен CLI-вывод при повторном исключении сервера (информативное сообщение вместо дублирования).
- clear-exclusions теперь гарантированно удаляет exclusions.json вне зависимости от наличия URL.

### Исправлено
- Исправлена идемпотентность exclusions: повторное добавление не дублирует записи.
- Исправлена обработка повреждённого exclusions.json (user-friendly сброс).
- Исправлена обработка невалидного URL (ошибка и returncode 1).
- Исправлены все баги, выявленные ручным и автоматическим тестированием CLI.

### Рефакторинг
- Проведён рефакторинг структуры проекта: код перенесён в src/, декомпозиция крупных модулей, обновлены импорты.
- Улучшена модульность и читаемость кода, подготовка к автотестам.

### Тестирование
- Весь CLI покрыт автотестами (pytest), ручной чеклист полностью автоматизирован.
- Покрытие тестами — 100% по ключевым сценариям CLI.

---

> Некоторые экспериментальные фичи (например, install wizard) пока не документируются официально и будут представлены в следующих релизах.

## [v1.3.0] - 2025-05-16

### Добавлено
- Инсталлятор (`install_update_singbox.sh`) для установки скрипта в `/usr/local/bin/`, настройки systemd-сервиса и таймера.
- Динамическое исключение серверов из правил маршрутизации по IP с помощью `ip_cidr` в шаблоне конфигурации.

### Изменено
- Обновлён `config.template.json`, добавлен placeholder `$excluded_servers` в поле `ip_cidr`.
- Улучшена логика скрипта: placeholder заменяется на реальные IP для прямой маршрутизации.

### Исправлено
- Гарантировано, что указанные IP маршрутизируются напрямую, минуя прокси.

### Закрытые задачи
- Issue #2: реализован инсталлятор и улучшена логика exclusions.

---

## [v1.2.1] - 2025-05-16

### Исправлено
- Улучшен вывод для опций `-e` и `-l` без необходимости повышать уровень логирования.
- `-e` теперь работает без `-u` при просмотре exclusions.
- Корректная обработка отсутствия опции `-u` (нет исключения).
- В exclusions теперь включаются теги серверов.
- Исправлен вывод портов серверов в списке.
- Исключены неподдерживаемые outbound-типы из списка серверов.
- Индексы серверов теперь начинаются с 0 и совпадают с индексом `-i`.

---

## [v1.2.0] - 2025-05-15

### Добавлено
- Возможность исключения и управления серверами.
- Опция вывода списка серверов с индексами и деталями через `-l`.
- Исключение серверов по индексу или имени через `-e`.
- Постоянное хранение exclusions в `exclusions.json`.
- Просмотр текущих exclusions.
- Очистка exclusions через `--clear-exclusions`.

### Изменено
- Функция `list_servers` теперь фильтрует только outbounds.
- Генерация конфигурации теперь всегда после исключения серверов.

### Исправлено
- Исправлен вывод имён и портов серверов в списке.

### Известные проблемы
 - Опции -e и -l не выводят результат без повышения уровня логирования (-d 1 или выше).
 - -e без индекса должен работать и без -u <url>, но сейчас не работает.
 - Теги серверов не включаются в exclusions.
 - Порты серверов иногда отображаются как N/A.
 - В списке серверов появляются неподдерживаемые outbound-типы.
 - Индексы серверов не всегда начинаются с 0 и могут не совпадать с -i.

---

## [v1.1.0] - 2025-05-14

### Добавлено
- Автоматический выбор сервера с помощью `urltest` для маршрутизации по задержке.
- Новые действия в секции `route` для DNS (`dns-out`) и маршрутизации приватных IP, замена устаревших `block` и `dns` outbounds.

### Изменено
- Удалены устаревшие outbounds `block` и `dns` (миграция на sing-box 1.11.0).
- Обновлён `config.template.json`, удалено не поддерживаемое поле `default` в urltest.
- Исправлены тесты в `test_protocol_validation.py` и `test_config_generate.py`.
- Обновлён README.md для отражения использования urltest и требований к версии sing-box.

### Исправлено
- Исправлен ValueError: Unsupported protocol: None в test_protocol_validation.py (корректное поле type).
- Исправлен json.decoder.JSONDecodeError в test_config_generate.py (валидный шаблон и корректный mock).

---

## [v1.0.0] - 2025-05-13

### Добавлено
- Автоматическое тестирование с использованием `pytest`.
- CI/CD процесс с помощью GitHub Actions:
  - Workflow для тестирования в ветке `dev`.
  - Workflow для релиза в ветке `main`.
- Документация:
  - `DEVELOPMENT.md` — процесс разработки.
  - `TESTING.md` — инструкция по тестированию.

### Изменено
- Улучшена структура проекта для поддержки тестирования и CI/CD.
- Модули перенесены в папку `modules/`:
  - `config_fetch.py`
  - `config_generate.py`
  - `protocol_validation.py`
  - `service_manage.py`
- Документация перенесена в папку `docs/`:
  - `README.md`
  - `CHANGELOG.md`
  - `DEVELOPMENT.md`
  - `TESTING.md`
- Тестовые файлы теперь используют `tests/config.json` вместо корневого `config.json`.

---

## [v0.3.0] - 2025-05-13

### Изменено
- Скрипт `update_singbox.py` разделён на модули для улучшения читаемости, тестируемости и расширяемости:
  - `logging_setup.py`: настройка логирования
  - `config_fetch.py`: загрузка и выбор конфигурации
  - `protocol_validation.py`: валидация протоколов и обработка настроек безопасности
  - `config_generate.py`: генерация и проверка конфигурации
  - `service_manage.py`: управление сервисом `sing-box`

---

## [v0.2.3] - 2025-05-13

### Добавлено
- Поддержка различных форматов подписок (Clash, SingBox, Base64).
- Автоматическое определение формата подписки.
- Валидация протоколов и настроек безопасности.
- Логирование операций и ошибок.

### Изменено
- Улучшена обработка ошибок и валидация конфигурации.
- Добавлена поддержка новых протоколов sing-box.

### Исправлено
- Исправлены проблемы с обработкой некорректных конфигураций.
- Улучшена совместимость с различными версиями sing-box.

---

## [v0.2.0] - 2025-05-12

### Добавлено
- Базовая функциональность для работы с sing-box конфигурациями.
- Поддержка загрузки конфигураций из URL.
- Генерация конфигурационных файлов.
- Управление sing-box сервисом.

### Изменено
- Первоначальная структура проекта.
- Базовая архитектура приложения.

### Исправлено
- Исправлены критические ошибки в обработке конфигураций.

---

## [v0.1.0] - 2025-05-11

### Добавлено
- Инициализация проекта SBoxMgr.
- Базовая структура для управления sing-box конфигурациями.
- Первоначальная документация.

### Изменено
- Создание репозитория и базовой архитектуры.

### Исправлено
- Начальная версия проекта.