# История изменений

## Другие языки / Other languages
- [English (../CHANGELOG.md)](../CHANGELOG.md)

# 1.4.0 (2025-06-20)

## Добавлено
- Полный рефакторинг CLI: переход на Typer для современной, модульной архитектуры.
- Все сценарии CLI (run, dry-run, exclusions, list-servers, clear-exclusions) реализованы как отдельные команды с единой логикой.
- Централизованное логирование (utils/logging.py), atomic file write и управление переменными окружения (utils/env.py).
- Добавлен .env.example со всеми поддерживаемыми переменными окружения.
- Entry point: CLI доступен как `sboxctl` после установки.
- CLI matrix-тесты: покрыты все сценарии, tolerant-поиск вывода.
- Новые onboarding и usage-примеры в документации.

## Изменено
- Вся бизнес-логика вынесена из CLI-обёрток в core-модули.
- CLI-обёртки теперь максимально тонкие (только orchestration).
- Структура каталогов приведена к best practice: cli/, core/, utils/, tests/.
- Все пути к артефактам (config, log, exclusions и др.) управляются через переменные окружения.
- Dev-зависимости вынесены в pyproject.toml (`pip install .[dev]`).
- Документация (README, DEVELOPMENT, TESTING, ru/) полностью обновлена и унифицирована.

## Исправлено
- Все тесты изолированы от .env и глобального окружения.
- Исправлены edge-case баги с exclusions, selected_config.json, возвратом сервера.
- Улучшена обработка ошибок для невалидных/пустых URL (всегда код возврата 1).
- Устранены DeprecationWarning (datetime и др.).

## Удалено
- requirements.txt удалён, все зависимости теперь только в pyproject.toml (PEP 621).
- Удалены все дублирующие, устаревшие и legacy-функции.
- Старые флаги и паттерны CLI объявлены deprecated.

## Breaking changes
- CLI полностью переведён на Typer: старые флаги/команды могут не работать.
- requirements.txt удалён, используйте только pyproject.toml.
- Все пути к артефактам теперь только через переменные окружения.
- CLI теперь только через `sboxctl` (entry point).

## Migration notes
- Скопируйте `.env.example` в `.env` и отредактируйте при необходимости.
- Для разработки используйте `pip install .[dev]`, для пользователей — `pip install .`.
- См. обновлённый README.md и usage-примеры для новых CLI-команд.

## Lessons learned
- Централизованное логирование и env значительно повышают поддерживаемость и тестируемость.
- Тонкие CLI-обёртки и модульная core-логика ускоряют рефакторинг и тестирование.
- Полная изоляция тестов и CLI matrix обеспечивают надёжное покрытие.
- Документирование lessons и архитектуры помогает будущим контрибьюторам.

## [1.3.1] — 2024-06-18

### Добавлено
- Полная автоматизация тестирования CLI: exclusions, clear-exclusions, идемпотентность, обработка ошибок, user-friendly сообщения, dry-run, selected_config.json, --list-servers, выбор excluded.
- User-friendly обработка ошибок при невалидном URL, повреждённом exclusions.json, попытке выбрать excluded сервер.
- Логирование ключевых CLI-действий и ошибок.

### Изменено
- exclusions.json теперь хранит только SHA256-хеши id, а для пользователя — человекочитаемое поле name.
- selected_config.json не создаётся и не изменяется в режиме --dry-run.
- Улучшен CLI-вывод при повторном исключении сервера (информативное сообщение вместо дублирования).
- clear-exclusions теперь гарантированно удаляет exclusions.json вне зависимости от наличия URL.

### Исправлено
- Исправлена идемпотентность exclusions: повторное добавление не дублирует записи.
- Исправлена обработка повреждённого exclusions.json (user-friendly сброс).
- Исправлена обработка невалидного URL (ошибка и returncode 1).
- Исправлены все баги, выявленные ручным и автоматическим тестированием CLI.

### Рефакторинг
- Проведён рефакторинг структуры проекта: код перенесён в src/, декомпозиция крупных модулей, обновлены импорты.
- Улучшена модульность и читаемость кода, подготовка к автотестам.

### Тестирование
- Весь CLI покрыт автотестами (pytest), ручной чеклист полностью автоматизирован.
- Покрытие тестами — 100% по ключевым сценариям CLI.

---

> Некоторые экспериментальные фичи (например, install wizard) пока не документируются официально и будут представлены в следующих релизах.

## [v1.3.0] - 2025-05-16

### Добавлено
- Инсталлятор (`install_update_singbox.sh`) для установки скрипта в `/usr/local/bin/`, настройки systemd-сервиса и таймера.
- Динамическое исключение серверов из правил маршрутизации по IP с помощью `ip_cidr` в шаблоне конфигурации.

### Изменено
- Обновлён `config.template.json`, добавлен placeholder `$excluded_servers` в поле `ip_cidr`.
- Улучшена логика скрипта: placeholder заменяется на реальные IP для прямой маршрутизации.

### Исправлено
- Гарантировано, что указанные IP маршрутизируются напрямую, минуя прокси.

### Закрытые задачи
- Issue #2: реализован инсталлятор и улучшена логика exclusions.

---

## [v1.2.1] - 2025-05-16

### Исправлено
- Улучшен вывод для опций `-e` и `-l` без необходимости повышать уровень логирования.
- `-e` теперь работает без `-u` при просмотре exclusions.
- Корректная обработка отсутствия опции `-u` (нет исключения).
- В exclusions теперь включаются теги серверов.
- Исправлен вывод портов серверов в списке.
- Исключены неподдерживаемые outbound-типы из списка серверов.
- Индексы серверов теперь начинаются с 0 и совпадают с индексом `-i`.

---

## [v1.2.0] - 2025-05-15

### Добавлено
- Возможность исключения и управления серверами.
- Опция вывода списка серверов с индексами и деталями через `-l`.
- Исключение серверов по индексу или имени через `-e`.
- Постоянное хранение exclusions в `exclusions.json`.
- Просмотр текущих exclusions.
- Очистка exclusions через `--clear-exclusions`.

### Изменено
- Функция `list_servers` теперь фильтрует только outbounds.
- Генерация конфигурации теперь всегда после исключения серверов.

### Исправлено
- Исправлен вывод имён и портов серверов в списке.

### Известные проблемы
 - Опции -e и -l не выводят результат без повышения уровня логирования (-d 1 или выше).
 - -e без индекса должен работать и без -u <url>, но сейчас не работает.
 - Теги серверов не включаются в exclusions.
 - Порты серверов иногда отображаются как N/A.
 - В списке серверов появляются неподдерживаемые outbound-типы.
 - Индексы серверов не всегда начинаются с 0 и могут не совпадать с -i.

---

## [v1.1.0] - 2025-05-14

### Добавлено
- Автоматический выбор сервера с помощью `urltest` для маршрутизации по задержке.
- Новые действия в секции `route` для DNS (`dns-out`) и маршрутизации приватных IP, замена устаревших `block` и `dns` outbounds.

### Изменено
- Удалены устаревшие outbounds `block` и `dns` (миграция на sing-box 1.11.0).
- Обновлён `config.template.json`, удалено не поддерживаемое поле `default` в urltest.
- Исправлены тесты в `test_protocol_validation.py` и `test_config_generate.py`.
- Обновлён README.md для отражения использования urltest и требований к версии sing-box.

### Исправлено
- Исправлен ValueError: Unsupported protocol: None в test_protocol_validation.py (корректное поле type).
- Исправлен json.decoder.JSONDecodeError в test_config_generate.py (валидный шаблон и корректный mock).

---

## [v1.0.0] - 2025-05-13

### Добавлено
- Автоматическое тестирование с использованием `pytest`.
- CI/CD процесс с помощью GitHub Actions:
  - Workflow для тестирования в ветке `dev`.
  - Workflow для релиза в ветке `main`.
- Документация:
  - `DEVELOPMENT.md` — процесс разработки.
  - `TESTING.md` — инструкция по тестированию.

### Изменено
- Улучшена структура проекта для поддержки тестирования и CI/CD.
- Модули перенесены в папку `modules/`:
  - `config_fetch.py`
  - `config_generate.py`
  - `protocol_validation.py`
  - `service_manage.py`
- Документация перенесена в папку `docs/`:
  - `README.md`
  - `CHANGELOG.md`
  - `DEVELOPMENT.md`
  - `TESTING.md`
- Тестовые файлы теперь используют `tests/config.json` вместо корневого `config.json`.

---

## [v0.3.0] - 2025-05-13

### Изменено
- Скрипт `update_singbox.py` разделён на модули для улучшения читаемости, тестируемости и расширяемости:
  - `logging_setup.py`: настройка логирования
  - `config_fetch.py`: загрузка и выбор конфигурации
  - `protocol_validation.py`: валидация протоколов и обработка настроек безопасности
  - `config_generate.py`: генерация и проверка конфигурации
  - `service_manage.py`: управление сервисом `sing-box`

---

## [v0.2.3] - 2025-05-13

### Добавлено
- Проверка изменений конфигурации перед применением.
- Перезапуск сервиса `sing-box` только при наличии изменений.

---

## [v0.2.2] - 2025-05-12

### Добавлено
- Уровни детализации логирования через флаг `--debug`:
  - `--debug 0`: минимум логов (по умолчанию)
  - `--debug 1`: информационные логи для ключевых действий
  - `--debug 2`: подробные логи для отладки

---

## [v0.2.1] - 2025-05-12

### Изменено
- Улучшение: процесс записи конфигурации переписан. Теперь конфиг сохраняется во временный файл, валидируется и только затем заменяет основной. Это предотвращает повреждение основного файла.

---

## [v0.2.0] - 2025-05-11

### Добавлено
- Поддержка прокси (SOCKS и HTTP) для загрузки удалённых конфигураций.
- Начало ведения CHANGELOG.md!

### Изменено
- Перешли с urllib на requests для поддержки прокси.

### Требования
- Добавлена зависимость: [requests](https://pypi.org/project/requests/). Убедитесь, что она установлена.

---

## [v0.1.0] - 2025-05-01

### Добавлено
- Изначальная версия с поддержкой VLESS и Shadowsocks.

## [Unreleased]

- Глубокий рефакторинг логики exclusions: удалены все дублирующие реализации, оставлена только singbox.server.exclusions.
- Централизован atomic file write: теперь только через singbox.utils.file.handle_temp_file.
- Удалены устаревшие функции и модули (management.py, temp.py, дублирующие exclusions-функции).
- Временные DeprecationWarning для плавного перехода (теперь не используются).
- Улучшена обработка ошибок при загрузке невалидных/пустых URL, всегда корректный код возврата и сообщение.
- Тесты CLI теперь не зависят от .env и переменных окружения, всегда проверяют именно переданный URL.
- Добавлен флаг --exclude-only: позволяет обновлять exclusions.json без генерации основного конфига.
- Проведён аудит и зачистка архитектуры, обновлён план рефакторинга в plans/struct_analysis_log.md.

## CLI-сценарии: входы и выходы

| Сценарий/Флаг                | Входные файлы           | Конфиги (чтение)         | Артефакты/выходы                |
|------------------------------|-------------------------|--------------------------|----------------------------------|
| -u <url>                     | config.template.json    | exclusions.json          | config.json, backup.json         |
| --dry-run                    | config.template.json    | exclusions.json          | (нет, только stdout)             |
| --list-servers               | config.template.json    | exclusions.json          | (нет, только stdout)             |
| --exclude <idx>              | config.template.json    | exclusions.json          | exclusions.json                  |
| --exclude-only               | config.template.json    | exclusions.json          | exclusions.json                  |
| --clear-exclusions           | exclusions.json         | exclusions.json          | exclusions.json (очищен/удалён)  |
| --remarks/-r <name>          | config.template.json    | exclusions.json          | config.json, backup.json         |
| --index/-i <n>               | config.template.json    | exclusions.json          | config.json, backup.json         |
| (без флагов, только -u)      | config.template.json    | exclusions.json          | config.json, backup.json         |

**Примечания:**
- exclusions.json всегда обновляется только при соответствующих действиях.
- config.json не изменяется в режиме --dry-run.
- merged.json и selected_config.json создаются только при определённых сценариях (см. код).
- Все артефакты пишутся в рабочую директорию или путь, заданный переменными окружения.

## [Unreleased] — CLI v2: переход на Typer, централизация логики

### Добавлено
- Новый CLI на Typer: команды run, dry-run, list-servers, exclusions, clear-exclusions.
- Автоматическая генерация help, алиасы, удобная структура команд.
- Все пути к артефактам управляются через переменные окружения (SBOXMGR_LOG, SBOXMGR_CONFIG и др.).

### Изменено
- Вся бизнес-логика CLI вынесена в cli_common.py и связанные модули.
- CLI-обёртка теперь thin: только маршрутизация, без дублирования логики.
- Старый main.py может быть удалён после миграции тестов.

### Исправлено
- Исключено дублирование логики между CLI и core-модулями.
- Тесты CLI проходят и для старого, и для нового интерфейса (до полной миграции).

### Best practices
- Для тестов CLI используйте Typer.CliRunner и monkeypatch для путей к артефактам.
- Все новые команды оформлять как отдельные функции/подкоманды Typer.