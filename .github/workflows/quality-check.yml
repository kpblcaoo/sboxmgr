name: Code Quality Check

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  quality:
    name: Code Quality
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install ruff mypy pre-commit
        pip install types-requests types-PyYAML types-toml

    - name: Run Ruff linter and formatter
      run: |
        ruff check src/ tests/ examples/ scripts/
        ruff format --check src/ tests/ examples/ scripts/

    - name: Run MyPy type checker
      run: |
        mypy src/sboxmgr/ --ignore-missing-imports --exclude "src/sboxmgr/tui/|src/sboxmgr/subscription/manager_legacy.py" --no-strict-optional --no-implicit-optional --no-warn-unused-ignores --no-warn-return-any --no-warn-unreachable --no-warn-no-return --no-warn-redundant-casts --no-warn-unused-configs --allow-untyped-defs --allow-untyped-calls

    - name: Check docstrings
      run: |
        ruff check src/ --select D --ignore D106,D107,D401

    - name: Check for security issues
      run: |
        pip install bandit
        bandit -r src/sboxmgr/ -f json -o bandit-report.json || true

    - name: Upload security report
      uses: actions/upload-artifact@v4
      with:
        name: security-report
        path: bandit-report.json

  documentation:
    name: Documentation Check
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install sphinx sphinx-rtd-theme

    - name: Check if docs can be built
      run: |
        if [ -d "docs" ]; then
          if [ -f "docs/Makefile" ] && [ -f "docs/conf.py" ]; then
            cd docs
            make html
          else
            echo "Docs directory exists but no Sphinx configuration found, checking Markdown files instead"
            # Check if there are Markdown files in docs
            if find docs -name "*.md" | head -1 | grep -q .; then
              echo "Found Markdown documentation files"
              # Basic syntax check for Markdown files
              for file in $(find docs -name "*.md"); do
                echo "Checking $file"
                if ! head -1 "$file" | grep -q "^#"; then
                  echo "Warning: $file doesn't start with a heading"
                fi
              done
            else
              echo "No Markdown files found in docs directory"
            fi
          fi
        else
          echo "No docs directory found, skipping documentation build"
        fi

    - name: Check README formatting
      run: |
        if [ -f "README.md" ]; then
          echo "README.md exists"
        else
          echo "Warning: README.md not found"
        fi
